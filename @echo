@echo off
setlocal enabledelayedexpansion

echo ========================================
echo    نصب کننده سیستم کاشف - شبح حبشی
echo ========================================
echo.
echo سیستم ملی تشخیص ماینینگ غیرمجاز
echo نسخه 2.0.0
echo.
echo وزارت نیرو - شرکت توانیر
echo ========================================
echo.

REM بررسی وجود Node.js
echo [بررسی] Node.js...
node --version >nul 2>&1
if %errorlevel% neq 0 (
    echo [خطا] Node.js نصب نشده است
    echo.
    echo لطفاً Node.js را از https://nodejs.org دانلود و نصب کنید
    echo نسخه 18 یا بالاتر مورد نیاز است
    echo.
    pause
    exit /b 1
)

echo [موفق] Node.js یافت شد
node --version
echo.

REM ایجاد پوشه‌های مورد نیاز
echo [ایجاد] پوشه‌های مورد نیاز...
if not exist "logs" mkdir logs
if not exist "data" mkdir data
if not exist "uploads" mkdir uploads
if not exist "backups" mkdir backups
if not exist "temp" mkdir temp

echo [موفق] پوشه‌های مورد نیاز ایجاد شدند
echo.

REM نصب وابستگی‌ها
echo [نصب] وابستگی‌ها...
echo این مرحله ممکن است چند دقیقه طول بکشد...
call npm install --production --no-optional

if %errorlevel% neq 0 (
    echo [خطا] نصب وابستگی‌ها ناموفق بود
    echo.
    echo لطفاً موارد زیر را بررسی کنید:
    echo 1. اتصال اینترنت
    echo 2. مجوزهای پوشه
    echo 3. فضای دیسک کافی
    echo.
    pause
    exit /b 1
)

echo [موفق] وابستگی‌ها نصب شدند
echo.

REM ایجاد دیتابیس اولیه
echo [راه‌اندازی] دیتابیس...
call node -e "const sqlite3 = require('sqlite3'); const db = new sqlite3.Database('ilam_mining.db'); db.close();"

if %errorlevel% neq 0 (
    echo [خطا] ایجاد دیتابیس ناموفق بود
    pause
    exit /b 1
)

echo [موفق] دیتابیس ایجاد شد
echo.

REM ایجاد کاربر پیش‌فرض
echo [ایجاد] کاربر پیش‌فرض...
call node -e "
const bcrypt = require('bcrypt');
const sqlite3 = require('sqlite3');
const db = new sqlite3.Database('ilam_mining.db');

db.serialize(() => {
  db.run(\`CREATE TABLE IF NOT EXISTS users (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    username TEXT UNIQUE NOT NULL,
    password TEXT NOT NULL,
    role TEXT DEFAULT 'admin',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    last_login DATETIME
  )\`);
  
  db.run(\`CREATE TABLE IF NOT EXISTS detected_miners (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    ip_address TEXT NOT NULL,
    mac_address TEXT,
    hostname TEXT,
    latitude REAL,
    longitude REAL,
    city TEXT,
    detection_method TEXT NOT NULL,
    suspicion_score INTEGER DEFAULT 0,
    confidence_score INTEGER DEFAULT 0,
    threat_level TEXT DEFAULT 'low',
    power_consumption REAL,
    hash_rate TEXT,
    device_type TEXT,
    process_name TEXT,
    notes TEXT,
    is_active TEXT DEFAULT 'true',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
  )\`);
  
  db.run(\`CREATE TABLE IF NOT EXISTS system_activities (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    type TEXT NOT NULL,
    description TEXT,
    user_id INTEGER,
    ip_address TEXT,
    timestamp DATETIME DEFAULT CURRENT_TIMESTAMP
  )\`);
  
  const hashedPassword = bcrypt.hashSync('admin123', 10);
  db.run(\`INSERT OR IGNORE INTO users (username, password, role) VALUES ('admin', ?, 'admin')\`, [hashedPassword]);
  
  console.log('دیتابیس و جداول ایجاد شدند');
});

db.close();
"

if %errorlevel% neq 0 (
    echo [خطا] ایجاد کاربر پیش‌فرض ناموفق بود
    pause
    exit /b 1
)

echo [موفق] کاربر پیش‌فرض ایجاد شد
echo.

REM ایجاد فایل تنظیمات
echo [ایجاد] فایل تنظیمات...
if not exist ".env" (
    echo NODE_ENV=production > .env
    echo PORT=3000 >> .env
    echo SESSION_SECRET=kashif-secret-key-change-in-production >> .env
    echo JWT_SECRET=kashif-jwt-secret-change-in-production >> .env
    echo DB_PATH=./ilam_mining.db >> .env
    echo CORS_ORIGIN=* >> .env
    echo RATE_LIMIT_WINDOW=15 >> .env
    echo RATE_LIMIT_MAX=100 >> .env
    echo LOG_LEVEL=info >> .env
    echo LOG_FILE=./logs/kashif.log >> .env
    echo SCAN_INTERVAL=300000 >> .env
    echo MAX_CONCURRENT_SCANS=5 >> .env
)

echo [موفق] فایل تنظیمات ایجاد شد
echo.

REM ایجاد فایل راه‌اندازی
echo [ایجاد] فایل راه‌اندازی...
echo @echo off > start-kashif.bat
echo setlocal enabledelayedexpansion >> start-kashif.bat
echo. >> start-kashif.bat
echo echo ======================================== >> start-kashif.bat
echo echo    کاشف - شبح حبشی - سیستم تشخیص ماینینگ >> start-kashif.bat
echo echo ======================================== >> start-kashif.bat
echo echo. >> start-kashif.bat
echo echo در حال راه‌اندازی سیستم... >> start-kashif.bat
echo echo. >> start-kashif.bat
echo echo آدرس دسترسی: http://localhost:3000 >> start-kashif.bat
echo echo نام کاربری: admin >> start-kashif.bat
echo echo رمز عبور: admin123 >> start-kashif.bat
echo echo. >> start-kashif.bat
echo echo برای توقف سیستم Ctrl+C را فشار دهید >> start-kashif.bat
echo echo. >> start-kashif.bat
echo call npm start >> start-kashif.bat
echo pause >> start-kashif.bat

echo [موفق] فایل راه‌اندازی ایجاد شد
echo.

REM تست اتصال
echo [تست] اتصال سیستم...
timeout /t 3 /nobreak >nul

echo.
echo ========================================
echo    نصب با موفقیت انجام شد!
echo ========================================
echo.
echo اطلاعات ورود:
echo نام کاربری: admin
echo رمز عبور: admin123
echo.
echo برای راه‌اندازی سیستم:
echo 1. فایل start-kashif.bat را اجرا کنید
echo 2. یا دستور npm start را اجرا کنید
echo.
echo آدرس دسترسی: http://localhost:3000
echo.
echo ========================================
echo    سیستم آماده استفاده است!
echo ========================================
echo.
pause